<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Local AI Multi-Object Cinematic Generator</title>
<style>
body{margin:0;padding:20px;background:#0b1220;color:#e6eef6;font-family:Inter,sans-serif;display:flex;justify-content:center;align-items:flex-start;min-height:100vh}
.container{max-width:1000px;width:100%;background:rgba(255,255,255,0.05);border-radius:12px;padding:20px;box-shadow:0 0 25px rgba(0,0,0,0.4)}
h1{margin-top:0;color:#6ee7b7;text-align:center}
label{display:block;margin-top:12px;font-size:14px}
textarea,input,select{width:100%;padding:10px;border-radius:8px;border:none;background:rgba(255,255,255,0.1);color:#fff;font-size:15px}
button{margin-top:12px;background:#6ee7b7;color:#0b1220;border:none;padding:10px 16px;border-radius:8px;cursor:pointer;font-weight:600}
video{width:100%;margin-top:14px;border-radius:8px;background:#000}
.note{font-size:13px;color:#aaa;text-align:center;margin-top:10px}
#uploads{margin-top:8px}
#uploads input{margin-top:4px}
</style>
</head>
<body>
<div class="container">
<h1>üêæ Local AI Multi-Object Cinematic Generator</h1>

<label>Scene Prompt</label>
<textarea id="prompt" rows="5" placeholder="e.g. Cat sees dog ‚Üí jumps ‚Üí dog chases cat"></textarea>

<label>Scene Duration (seconds)</label>
<input id="duration" type="number" min="1" max="20" value="8">

<label>Upload Object Images (optional, multiple)</label>
<div id="uploads">
  <input type="file" id="userImages" accept="image/*" multiple>
</div>

<button id="generate">Generate Reel</button>
<video id="preview" controls></video>
<div class="note">Local AI generation + object behavior sequencing + browser TTS + canvas animation.</div>
</div>

<script>
const btn=document.getElementById('generate');
const preview=document.getElementById('preview');
const userImagesInput=document.getElementById('userImages');

// Convert uploaded images to base64 for canvas usage
async function filesToBase64(files){
  const promises=[];
  for(const file of files){
    promises.push(new Promise(res=>{
      const reader=new FileReader();
      reader.onload=()=>res(reader.result);
      reader.readAsDataURL(file);
    }));
  }
  return Promise.all(promises);
}

// Simple behavior sequencer per object
function behaviorSequencer(objects, t){
  objects.forEach(obj=>{
    const step=obj.behaviors[obj.currentStep]||{dx:0,dy:0,scale:1};
    obj.x+=step.dx;
    obj.y+=step.dy;
    obj.scale=step.scale||1;
    obj.currentFrame++;
    if(obj.currentFrame>=step.duration){ obj.currentFrame=0; obj.currentStep=(obj.currentStep+1)%obj.behaviors.length; }
  });
}

// Render local AI video
async function renderVideo(prompt,duration,userImages){
  const canvas=document.createElement('canvas');
  canvas.width=720; canvas.height=1280;
  const ctx=canvas.getContext('2d');
  const fps=30; const totalFrames=duration*fps;
  const objects=[];

  // Load uploaded images as objects
  if(userImages && userImages.length){
    for(const imgSrc of await filesToBase64(userImages)){
      const img=new Image();
      img.src=imgSrc;
      await img.decode();
      objects.push({img,x:360,y:640,scale:1,behaviors:[{dx:Math.random()*4-2,dy:Math.random()*2,scale:1.0,duration:fps}],currentStep:0,currentFrame:0});
    }
  } else {
    // placeholder objects if no images uploaded
    const img=new Image();
    img.crossOrigin='anonymous';
    img.src='https://source.unsplash.com/200x200/?'+encodeURIComponent(prompt.split(' ')[0]);
    await img.decode();
    objects.push({img,x:360,y:640,scale:1,behaviors:[{dx:1,dy:0,scale:1,duration:fps}],currentStep:0,currentFrame:0});
  }

  const stream=canvas.captureStream(fps);
  const rec=new MediaRecorder(stream,{mimeType:'video/webm'});
  const chunks=[];
  rec.ondataavailable=e=>{if(e.data.size)chunks.push(e.data)};
  const done=new Promise(res=>rec.onstop=()=>res(new Blob(chunks,{type:'video/webm'})));
  rec.start();

  for(let f=0;f<totalFrames;f++){
    ctx.clearRect(0,0,canvas.width,canvas.height);
    behaviorSequencer(objects,f);
    // draw each object
    objects.forEach(obj=>{
      const w=obj.img.width*obj.scale;
      const h=obj.img.height*obj.scale;
      ctx.drawImage(obj.img,obj.x-w/2,obj.y-h/2,w,h);
    });
    // draw prompt text
    ctx.fillStyle='rgba(255,255,255,0.9)';
    ctx.font='bold 32px sans-serif';
    ctx.textAlign='center';
    ctx.fillText(prompt,canvas.width/2,120);
    await new Promise(r=>setTimeout(r,1000/fps));
  }

  rec.stop();
  return done;
}

// Browser TTS for narration
function playTTS(text){
  const synth=window.speechSynthesis;
  const utter=new SpeechSynthesisUtterance(text);
  synth.speak(utter);
}

btn.onclick=async()=>{
  const prompt=document.getElementById('prompt').value.trim();
  const duration=parseInt(document.getElementById('duration').value)||8;
  const userImages=userImagesInput.files.length?userImagesInput.files:null;

  if(!prompt)return alert('Enter a scene prompt');
  btn.disabled=true; btn.textContent='Generating...';

  try{
    playTTS(prompt);
    const blob=await renderVideo(prompt,duration,userImages);
    preview.src=URL.createObjectURL(blob);
  }catch(e){console.error(e); alert('Error: '+e);}
  btn.disabled=false; btn.textContent='Generate Reel';
};
</script>
</body>
</html>
